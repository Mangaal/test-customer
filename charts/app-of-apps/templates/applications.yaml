{{- $argocdNamespace := .Values.argocdNamespace | default "argocd" -}}
{{- $defaultDestServer := .Values.defaultDestinationServer | default "https://kubernetes.default.svc" -}}
{{- $defaultProject := .Values.defaultProject | default "default" -}}

{{- range .Values.apps }}
---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: {{ .name }}
  namespace: {{ $argocdNamespace }}
{{- if .labels }}
  labels:
{{ toYaml .labels | indent 4 }}
{{- end }}
{{- if or (eq .name "titan") (eq .name "titan-argocd-9") .annotations }}
  annotations:
{{- if or (eq .name "titan") (eq .name "titan-argocd-9") }}
    argocd.argoproj.io/sync-options: ServerSideApply=true
{{- end }}
{{- if .annotations }}
{{ toYaml .annotations | indent 4 }}
{{- end }}
{{- end }}
spec:
  project: {{ .project | default $defaultProject }}
  source:
    repoURL: {{ .source.repoURL }}
    targetRevision: {{ .source.targetRevision | default "HEAD" }}
    path: {{ .source.path | quote }}
{{- if .source.helm }}
    helm:
{{ toYaml .source.helm | indent 6 }}
{{- end }}
  destination:
    server: {{ .destination.server | default $defaultDestServer | quote }}
    namespace: {{ .destination.namespace | quote }}
{{- if .syncPolicy }}
  syncPolicy:
{{ toYaml .syncPolicy | indent 4 }}
{{- end }}
{{- if .syncOptions }}
  syncOptions:
{{- range .syncOptions }}
    - {{ . }}
{{- end }}
{{- end }}
{{- end }}


